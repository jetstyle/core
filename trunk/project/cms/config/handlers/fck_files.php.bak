<?
/*это то что раньше было  picfile
 *@author: nop
 *@last-mod: 14:28 01.06.2006
 */ 
    $rh->DIRS["templates"][2] = $rh->path_full.'FCKeditor/editor/';


    if ($rh->path->path_trail != "" && $rh->path->path_trail!="fck_files")
    {
        
    	$rh->HeadersNoCache();
    	
    	$tpl->assign ('tpl_pict', str_replace('"', "'", $tpl->action('cutoff_html',$tpl->parse('for_js/file.html'))));
//        $tpl->assign ('tpl_preview', str_replace('"', "'", $tpl->action('cutoff_html',$tpl->parse('for_js/pict_preview.html'))));
       // $rh->DIRS["templates"][2] = $rh->path_full.'FCKeditor/editor/';

    	
    	$mode = $path->path_trail=='list' ? 1 : 0;
    	if($mode==1)
    		$suffix = '_lists';
    	
    	$rh->UseClass('Upload');
    	$upload =& new Upload($rh,'files/');

    	$table_topics = $rh->project_name.'_picfiles'.$suffix.'_topics';
    	$table_picts = $rh->project_name.'_picfiles'.$suffix;
    	
    	$rh->UseClass('DBDataView');
    	
    	//load topics, render topics select
    	$topics = new DBDataView( $rh, $table_topics, array('id','title'), '_state=0', 'title ASC');
    	$topics->Load();
    	$nt = count($topics->ITEMS);
    	for($i=0;$i<$nt;$i++)
    		$topics_options .= "<option value='".$topics->ITEMS[$i]['id']."'>".iconv('windows-1251', 'utf-8',$topics->ITEMS[$i]['title'])."\n";
    	
    	//грузим картинки, раскладываем по ID и topic_id
    	$picts = new DBDataView( $rh, $table_picts, array('id','title','descr','topic_id'), 'topic_id>0 AND _state=0', 'topic_id ASC, title ASC');
    	$picts->Load();
    	$n = count($picts->ITEMS);
    	for($i=0;$i<$n;$i++){
    		$r = (object)$picts->ITEMS[$i];
    		$_fname = 'picfile'.$suffix.'_'.$r->id;
    		if( $file_small = $upload->GetFile($_fname) ){
    			//заполн€ем списки дл€ разделов
    			$src_small = $rh->path_rel.'pic_file/picfiles'.( $mode ? '_lists' : '' ).'/'.$r->id;
    			$BY_TOPICS[$r->topic_id][] = array( $r->id, iconv('windows-1251', 'utf-8',htmlspecialchars($r->title)) );
    			$_array = "['".$src_small."','".str_replace("'","\'",iconv('windows-1251', 'utf-8',$r->title))."','".$file_small->size."kb, ".$file_small->format."','".str_replace("'","\'",iconv('windows-1251', 'utf-8',$r->descr))."']";
    			$rv_str .= "arrrv[".$r->id."] = ".$_array.";\n";
    			$BY_TOPICS_1[$r->topic_id][] = $_array;
    		}
    	}

    	//рендерим js-масивы по разделам
    	for($i=0;$i<$nt;$i++){
    		$r = (object)$topics->ITEMS[$i];
    		$arrv = $arrt = "";
    		$A =& $BY_TOPICS[ $r->id ];
    		$n = count($A);
    		for($j=0;$j<$n;$j++){
    			$arrt .= ( $j ? ', ' : '' ).'"'.$A[$j][1].'"';
    			$arrv .= ( $j ? ', ' : '' ).'"'.$A[$j][0].'"';
    		}
    		$titles_str .= "arrt[".$r->id."] = new Array(".$arrt.");\n";
    		$values_str .= "arrv[".$r->id."] = new Array(".$arrv.");\n";
    		$topics_rv_str .= "arrrvt[".$r->id."] = [\n   ".( is_array($BY_TOPICS_1[ $r->id ]) ? implode(",\n   ",$BY_TOPICS_1[ $r->id ]) : '')."\n];\n";
    	}

    	//вставл€ем в шаблон
    	$tpl->Assign( 'TOPICS', $topics_options );
    	$tpl->Assign( 'TITLES', $titles_str );
    	$tpl->Assign( 'VALUES', $values_str );
    	$tpl->Assign( 'RETURN_VALUES', $rv_str );
    	$tpl->Assign( 'TOPICS_RETURN_VALUES', $topics_rv_str );

    	//рендерим обработчик кнопки ќ 
    	//$tpl->Parse( $template.($mode == 1 ? ':onOk_2' : ':onOk_1' ) , 'onOk' );

	//возврашаем шаблон
    	$template = 'nop_insert_file.html';
	    $tpl->parse($template, 'foo');
        echo $tpl->parse($rh->path->path_trail);
        //die();
    }
    else 
    {
        echo $tpl->parse('nop_fckdialog.html');
    }
    die();
?>