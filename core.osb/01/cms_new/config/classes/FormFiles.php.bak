<?
/*
  В конфиге должно быть:
  ---------------------
  $this->FILES = array(
    array( file_name, input_name [, array('doc','rtf',...), array(max_width,max_height,strict)] ),
    ...
  );
*/
  
  $this->UseClass('FormSimple');
  
class FormFiles extends FormSimple  {
  
  var $upload;
  var $GRAPHICS = array('gif','jpg','png','bmp','jpeg'); //какие форматы показывать как картинки
  var $max_file_size = 2097152; //максимальный размер файла для загрузки

  //До каких размеров картинки показывать просто, а больше - через превью и попап?
  var $view_width_max = 300;
  var $view_height_max = 300;
  
  function FormFiles( &$config ){
    FormSimple::FormSimple($config);
    //upload
    $this->rh->UseClass('Upload');
    $this->upload =& new Upload( $this->rh, $config->upload_dir ? $config->upload_dir : 'files/' );
  }
  
  function Handle(){
    $rh =& $this->rh;
    $tpl =& $rh->tpl;
    $upload =& $this->upload;
    $config =& $this->config;
    
    //грузим форму
    $this->Load();
    
    $this->RenderFiles();
    
    //по этапу
    FormSimple::Handle();
  }
  
  function RenderFiles(){
    if( $this->files_rendred ) return;
    
    $rh =& $this->rh;
    $tpl =& $rh->tpl;
    $upload =& $this->upload;
    $config =& $this->config;
    
    //рендерим файлы
    if( is_array($config->FILES) ){
      foreach($config->FILES as $row){
        if( $file = $upload->GetFile( $row[0].'_'.$this->id ) ){
          if( in_array( $file->ext, $this->GRAPHICS ) ){
            //графика? показываем
            $A = @getimagesize( $file->name_full );
            $width_max = $config->view_width_max ? $config->view_width_max : $this->view_width_max;
            $height_max = $config->view_height_max ? $config->view_height_max : $this->view_height_max;
            if( $A[0]>$width_max || $A[1]>$height_max ){
              //слишком большая? показываем превью
              $_href = $rh->url.'picture?pict='.$file->name_short;
              $_onclick = "pictwnd('$_href','popup_".$this->id."','top=100,left=100,width=".$A[0].", height=".$A[1]."');";
              $_str = '<a href="'.$_href.'" onclick="'.$_onclick.'return false;"><img src="'.$rh->url.'pict.php?img='.$file->link.'" width="100" height="100" alt="'.$file->link.'" border="0"></a>';
              $tpl->Assign( 'file_'.$row[1], $_str );
            }else
              //достаточно маленькая? показываем целиком
              $tpl->Assign( 'file_'.$row[1], '<img src="'.$rh->url.'pict.php?img='.$file->link.'" "'.$A[3].'" alt="'.$file->link.'">' );
          }else{
            //файл? рисуем статистику и ссылку "скачать"
            $_href = $rh->url.'get_file/'.$file->name_short;
//            $_href = $rh->url.'files/'.$file->name_short;
            $tpl->Assign( 'file_'.$row[1], '('.$file->size.'kb, '.$file->format.", <a href='".$_href."'>скачать</a>)" );
          }
        }
      }
    }
    $tpl->Assign( '__max_file_size', $config->max_file_size ? $config->max_file_size : $this->max_file_size );
    $this->files_rendered = true;
  }
  
  function Update(){
    if( FormSimple::Update() ){
      $rh =& $this->rh;
      //загружаем и удаляем файлы
      $upload =& $this->upload;
      if( is_array($this->config->FILES) )
        foreach($this->config->FILES as $row){
          $fname = $row[0].'_'.$this->id;
          //грузим файл и проверяем формат, если нужно
          if($this->config->RESIZE)
          	$file = $upload->UploadFile( $this->prefix.$row[1], $fname, false, array($row[3][0], $row[3][1]));
          else
          	$file = $upload->UploadFile( $this->prefix.$row[1], $fname );
          $kill = false;
          if( is_array($row[2]) && count($row[2]) && !in_array( $file->ext, $row[2]) )
            $kill = true;
          //проверяем ограничение на линейные размеры
          if(is_array($row[3])){
            $A = @getimagesize( $file->name_full );
            if(
              $row[3][2] && ( $row[3][0] && $A[0]!=$row[3][0] || $row[3][1] && $A[1]!=$row[3][1]) || //строгие размеры
              ($row[3][0]>0 && $A[0]>$row[3][0]) || //по щирине
              ($row[3][1]>0 && $A[1]>$row[3][1]) //по высоте
              )
              $kill = true;
          }
          //удаляем файл, если нужно
          if( $rh->GetVar($this->prefix.$row[1].'_del') ){
            if( !$file ) $file = $upload->GetFile($fname);
            $kill = true;
//            @unlink( $file->name_full );
          }
          if($kill && $file)
            @unlink( $file->name_full );
        }
      return true;
    }else 
        return false;
  }

}
  
?>