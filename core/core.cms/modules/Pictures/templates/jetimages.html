<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html>
<head>
<title>{{TITLE}}</title>
  <meta http-equiv="Content-Type" content="text/html; charset=windows-1251">
  <script type="text/javascript" src="{{/}}libs/tinymce/tiny_mce_popup_simple.js"></script>
	<link rel="stylesheet" href="{{css}}all.css" media="all" type="text/css" />
	<link rel="stylesheet" href="{{css}}popup.css" media="all" type="text/css" />
</head>

<body>

<div class="form">

	<form name="rubric" method="get" action="">
	  <h2 style="margin-top: 0">
	  <label for="rubric-select">Картинки из рубрики:</label>
		<select name="rubric_id" id="rubric-select" onchange="document.forms['rubric'].submit()">
			<option value="0">Все вместе</option>
			{{!for rubrics do=@:rubric}}
			{{:rubric}}
				<option value="{{*id}}" {{?*selected}}selected="selected"{{/?}}>{{*title}}</option>
			{{/:rubric}}
			{{:rubric_sep}}{{/:rubric_sep}}
		</select>
		</h2>
	</form>		

	<div>
		{{@blocks/pager.html}}		
	</div>

<div class="gallery clearfix">
 	<div id="images"></div>
</div>

<div class="group- variants-">
  <h3>Выберите картинку,<br />
  <small>которая вставится как</small></h3>

	<input type="radio" name="mode" id="mode1" value="1" checked /> <label for="mode1">маленькая со ссылкой на большую</label>
	<br />
	<input type="radio" name="mode" id="mode2" value="2" /> <label for="mode2">маленькая</label>
	<br />
	<input type="radio" name="mode" value="3" id="mode3" /> <label for="mode3">большая</label>
	<br />
</div>

<div class="buttons-">
	<input type="submit" name="submit" value="Вставить" id="submit"
	  onclick="if (selectedImage) insertImage(selectedImage); return false;" />
  <input type="button" name="Закрыть" value="Закрыть" onclick="window.close();" />
</div>

</div>

<script language="javascript">
	var images = {{files}};
	var selectedImage = null;
	var imgCont = null;
	
	function onImageClick()
	{
		var all = this.parentNode.parentNode;
    	if (selectedImage)
    	{
	    	selectedImage.parentNode.className='frame-'
	    }
    
	  	this.parentNode.className='frame- sel-'
	  	selectedImage = this;
	}
	
	window.onload = function()
	{
		imgCont = document.getElementById('images');
		var maxHeight = 0;
		var maxWidth = 0;
		for (var i in images)
		{
		    maxHeight = Math.max(maxHeight, images[i].height.preview);
		    maxWidth = Math.max(maxWidth, images[i].width.preview);
		}
		
		for (var i in images)
		{
			var div = document.createElement('div');
			var frame = document.createElement('div');
			var img = document.createElement('img');
			var title = document.createElement('div');

			img.setAttribute('src', images[i].src.preview);
			img.setAttribute('id', i);
			img.style.marginTop = ''+((maxHeight - images[i].height.preview)/2-1)+'px';
			img.onclick = onImageClick;

			title.innerHTML = images[i].title;
			title.className = "title-"			

			frame.appendChild(img);
			frame.className = 'frame-';			
			frame.style.height = ''+maxHeight+'px'
			frame.style.width = ''+maxWidth+'px'

			div.style.height = ''+(maxHeight+12)+'px'
			div.style.width = ''+(maxWidth+12)+'px'

			div.appendChild(frame);
			div.appendChild(title);

			div.className = 'img-';			
			
			imgCont.appendChild(div);
		}
		var div = document.createElement('div');
		div.style.clear = 'both';
		imgCont.appendChild(div);
	} 
	
	function insertImage(el)
	{
		id = el.getAttribute('id');
		els = document.getElementsByName('mode');
		var mode = 1;
		if(els)
		{
			for(i=0; i<els.length; i++)
			{
				if(els[i].checked)
				{
					mode = els[i].value;
				}
			}
		}
		
		if(mode == 1)	
		{
			var h = '<img src="'+images[id].src.preview+'" mode="'+mode+'" bigwidth="'+images[id].width.normal+'" bigheight="'+images[id].height.normal+'" bigsrc="'+images[id].src.normal+'" alt="'+images[id].title+'" width="'+images[id].width.preview+'" height="'+images[id].height.preview+'" />';
		}
		else if(mode == 2)
		{
			var h = '<img src="'+images[id].src.preview+'" mode="'+mode+'" alt="'+images[id].title+'" width="'+images[id].width.preview+'" height="'+images[id].height.preview+'" />';
		}
		else
		{
			var h = '<img src="'+images[id].src.normal+'" mode="'+mode+'" alt="'+images[id].title+'" width="'+images[id].width.normal+'" height="'+images[id].height.normal+'" />';
		}			
						
		tinyMCEPopup.execCommand('mceInsertContent', false, h);
		tinyMCEPopup.close();
	}
	
</script>

</body>
</html>